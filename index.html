<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomi Services | Professional TikTok Growth</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        body { background: var(--bg); font-family: 'Poppins', sans-serif; padding-top: 60px; }
        #top-bar { position: fixed; top: 0; left: 0; width: 100%; background: #E0F7FA; color: #1976D2; padding: 10px 0; z-index: 1000; font-weight: bold; border-bottom: 1px solid #B2EBF2; }
        .service-card { background: white; border-radius: 15px; padding: 30px; border: 1px solid #e2e8f0; cursor: pointer; transition: 0.3s; text-align: center; }
        .service-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .order-box { background: white; border-radius: 20px; padding: 30px; max-width: 500px; margin: 30px auto; box-shadow: 0 10px 25px rgba(0,0,0,0.05); display: none; }
    </style>
</head>
<body>

<div id="top-bar">
    <marquee id="live-limit" direction="left" scrollamount="4">لوڈنگ ہو رہی ہے...</marquee>
</div>

<div class="container mt-5">
    <div class="text-center mb-5">
        <h1 class="fw-bold">Roomi <span class="text-primary">Services</span></h1>
        <p class="text-muted">Safe & Instant Social Media Solutions</p>
    </div>

    <div class="row">
        <div class="col-md-5 mx-auto">
            <!-- TikTok Service Card -->
            <div class="service-card" onclick="document.getElementById('order-section').style.display='block'">
                <div class="mb-3"><i class="fas fa-heart fa-3x text-primary"></i></div>
                <h4>TikTok Likes</h4>
                <p class="small text-muted">High Retention • 10K Global Limit</p>
                <span id="badge-limit" class="badge bg-primary rounded-pill">Checking Stock...</span>
            </div>

            <!-- Form -->
            <div id="order-section" class="order-box">
                <form id="orderForm">
                    <div class="mb-3">
                        <label class="form-label">TikTok Video Link</label>
                        <input type="url" id="targetLink" class="form-control" placeholder="https://www.tiktok.com/@user/video/..." required>
                    </div>
                    <div class="mb-4">
                        <label class="form-label">Quantity</label>
                        <input type="number" id="targetQty" class="form-control" placeholder="Min 100" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2 fw-bold">Place Order</button>
                </form>
            </div>
        </div>
    </div>

    <!-- History -->
    <div class="mt-5">
        <h5 class="mb-3 text-center"><i class="fas fa-sync fa-spin me-2 text-primary"></i>Live Orders Activity</h5>
        <div class="table-responsive bg-white rounded-3 shadow-sm p-3">
            <table class="table align-middle">
                <thead><tr><th>Order ID</th><th>Quantity</th><th>Status</th></tr></thead>
                <tbody id="orderHistory"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- YOUR FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyDASz6i9dwy_LKDsuHbyAvSNjdwtRuaPm4",
      authDomain: "roomiliks.firebaseapp.com",
      databaseURL: "https://roomiliks-default-rtdb.firebaseio.com",
      projectId: "roomiliks",
      storageBucket: "roomiliks.firebasestorage.app",
      messagingSenderId: "1062299998503",
      appId: "1:1062299998503:web:f0e0488eeab60724f0f102"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 1. Live Limit Listener
    db.ref('likes_limit').on('value', (snap) => {
        const val = snap.val() || 0;
        document.getElementById('live-limit').innerText = `آپ کے ${val.toLocaleString()} لائکس باقی رہ گئے ہیں`;
        document.getElementById('badge-limit').innerText = `Stock: ${val.toLocaleString()}`;
    });

    // 2. Order Submission
    document.getElementById('orderForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const link = document.getElementById('targetLink').value;
        const qty = parseInt(document.getElementById('targetQty').value);

        const snap = await db.ref('likes_limit').once('value');
        const currentLimit = snap.val();

        if (qty > currentLimit) {
            return Swal.fire('Out of Stock', `Hamare paas sirf ${currentLimit} likes bache hain.`, 'warning');
        }

        Swal.fire({ title: 'Connecting to Server...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        try {
            // BACKEND CALL (/api/order.js)
            const response = await fetch('/api/order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    service: '4772', // Aapka TikTok service ID
                    link: link,
                    quantity: qty
                })
            });

            const result = await response.json();

            if (result.order) {
                // Subtract from Firebase
                await db.ref('likes_limit').set(currentLimit - qty);

                // Save Order Record
                await db.ref('orders/' + result.order).set({
                    link: link, qty: qty, time: Date.now()
                });

                Swal.fire('Order Success!', `Order ID: #${result.order}`, 'success');
                document.getElementById('orderForm').reset();
            } else {
                Swal.fire('API Error', result.error || 'Failed to place order', 'error');
            }
        } catch (err) {
            Swal.fire('Error', 'Server connection failed!', 'error');
        }
    });

    // 3. Activity Feed
    db.ref('orders').limitToLast(8).on('value', snap => {
        const list = document.getElementById('orderHistory');
        list.innerHTML = '';
        snap.forEach(child => {
            const o = child.val();
            list.innerHTML = `<tr>
                <td>#${child.key}</td>
                <td>${o.qty}</td>
                <td><span class="badge bg-success">Processing</span></td>
            </tr>` + list.innerHTML;
        });
    });
</script>
</body>
</html>
